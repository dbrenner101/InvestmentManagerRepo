<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<link rel="stylesheet" type="text/css" href="css/init_styles.css">
    <link rel="stylesheet" type="text/css" href="js/dojo-themes/dojo.css">
    <link rel="stylesheet" type="text/css" href="js/dojo-themes/dgrid.css">
    <link rel="stylesheet" type="text/css" href="js/dojo-themes/soria/soria.css">
    <link rel="stylesheet" type="text/css" href="js/dojo-themes/tundra/tundra.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.min.js" integrity="sha512-sW/w8s4RWTdFFSduOTGtk4isV1+190E/GghVffMA9XczdJ2MDzSzLEubKAs5h0wzgSJOQTRYyaz73L3d6RtJSg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="//ajax.googleapis.com/ajax/libs/dojo/1.14.1/dojo/dojo.js"></script>
    
	<meta charset="UTF-8">
	<title>Portfolio Performance</title>
</head>
<body class="tundra">

	<div id="mainMenu" data-dojo-type="dijit/MenuBar"></div>
    
    <div id="jsonResult"></div>

    <!-- <div th:insert="~{fragments :: menu}"></div> -->
    <p></p>
    
    <form class="formFormat">
        <fieldset>
            Investment: <select name="investment" id="investmentSelect">
                <option value="">Select</option>
                <option value="all">All</option>
                <option th:each="investment : ${investments}" th:value="${investment.symbol}" th:text="${investment.symbol + ' :: ' + investment.companyName}"/>
            </select>&nbsp;&nbsp;  
            <input type="radio" name="numMonths" value="0" id="numMonthsRadio" checked onclick="loadChartData()"/> All
            <input type="radio" name="numMonths" value="1" id="numMonthsRadio" onclick="loadChartData()"/> 1 month
            <input type="radio" name="numMonths" value="3" id="numMonthsRadio" onclick="loadChartData()"/> 3 months
            <input type="radio" name="numMonths" value="6" id="numMonthsRadio" onclick="loadChartData()"/> 6 months
        </fieldset>
    </form>

    
    <div class="chart-container" style="position: relative; height:20vh; width:60vw">
        <canvas id="historicalPerformanceChart"></canvas>
    </div>

    <script>require(["js/menu.js"], function(applyMenu){});</script>
    
    <script>
    
        var graphData;
        
        // Our labels along the x-axis
        var dateLabels = new Array();
        // For drawing the lines
        var closeData = new Array();
    
        var config = {
           type: 'bar',
           data: {
             labels: [],
             datasets: [
               { 
                 data: [],
                 label: "",
                 backgroundColor: "#457fa3",
                 fill: true
               }]
           },
           options: {
               scales: {
                   y: {
                       beginAtZero:true
                       }
               },
               title: {
                   display: false,
                   text: ""
               },
               tooltips: {
               	callbacks: {
               		label: function(tooltipItem, data) {
               			return "$" + Number(tooltipItem.yLabel).toFixed(0).replace(
               					/./g, 
               					function(c, i, a) {
               					    return i > 0 && c !== "." && (a.length - i) % 3 === 0 ? "," + c : c;
               					}
               			);
               		}
               	}
               }
           }
         };
        
        var ctx = document.getElementById("historicalPerformanceChart").getContext("2d");
        const myChart = new Chart(document.getElementById("historicalPerformanceChart"), config);
        
        
        document.getElementById('investmentSelect').addEventListener('change', function() {
            loadChartData();
        });
        
    
        function loadChartData() {
            var xhttp = new XMLHttpRequest();
            
            var symbol = document.getElementById("investmentSelect").value;
            var numDays = document.querySelector('input[name="numMonths"]:checked').value;
            
            document.getElementById("historicalPerformanceChart").innerHTML = "";
            
            xhttp.onreadystatechange = function() {
                
                if (this.readyState == 4 && this.status == 200) {
                    var response = JSON.parse(this.responseText);
                    graphData = response
                    
                    var newDateLabels = new Array();
                    var newCloseData = new Array();
                    
                    if (graphData != null) {
                        for (let i=0; i < graphData.length; i++) {
                            newDateLabels[i] = graphData[i].quoteDate;
                            newCloseData[i] = graphData[i].marketValue;
                        }
                    }
                    
                    /* var jsonResult = document.getElementById("jsonResult");
                    jsonResult.innerHTML=this.responseText; */
                    
                    removeData(myChart);
                    addData(myChart, newDateLabels, newCloseData, symbol);
                }
            };
            xhttp.open("GET", "getPortfolioPerformanceAjax?symbol=" + symbol + "&numDays=" + numDays, true);
            xhttp.send();
        }
        

        
        Number.prototype.formatMoney = function(c, d, t){
            var n = this, 
            c = isNaN(c = Math.abs(c)) ? 2 : c, 
            d = d == undefined ? "." : d, 
            t = t == undefined ? "," : t, 
            s = n < 0 ? "-" : "", 
            i = String(parseInt(n = Math.abs(Number(n) || 0).toFixed(c))), 
            j = (j = i.length) > 3 ? j % 3 : 0;
           return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
         };
        
        function addData(chart, labels, data, symbol) {
            //if (config.data.datasets.length > 0) {
                var newDataSet = {
                    label: 'New Label',
                    label: symbol + " Performance",
                    backgroundColor: "#457fa3",
                    fill: true,
                    data: data
                  };
                chart.data.labels = labels;
                config.data.datasets.push(newDataSet);
                myChart.update();
            //}
        }
        
        function removeData(chart) {
            chart.data.labels.pop();
            config.data.datasets.pop();
            myChart.update();
        }
    
        function buildChart() {
            
            var ctx = document.getElementById("historicalPerformanceChart").getContext("2d");
            var myChart = new Chart(ctx, config);
        }
    
    </script>
    
    

</body>
</html>